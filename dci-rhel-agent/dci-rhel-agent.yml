---
- name: 'Schedule a new job'
  hosts: localhost
  gather_facts: false
  tasks:
    - name: 'Read credentials from env vars'
      set_fact:
        dci_client_id="{{ lookup('env','DCI_CLIENT_ID') }}"
        dci_api_secret="{{ lookup('env','DCI_API_SECRET') }}"
        dci_cs_url="{{ lookup('env','DCI_CS_URL') }}"
      no_log: true

    - name: 'Schedule a new job in DCI Control Server'
      dci_job:
        components: '{{ dci_components }}'
        components_by_query: "{{ dci_components_by_query }}"
        topic: '{{ topic }}'
        comment: "{{ dci_comment | default('') }}"
        url: "{{ dci_url | default('') }}"
        name: "{{ dci_name | default('') }}"
        configuration: "{{ dci_configuration | default('') }}"
      register: job_info

    - name: 'Debug dci_job_id'
      debug:
        msg: dci_job_id:"{{ job_info['job']['id'] }}"

    - name: 'Set global variables'
      set_fact:
        job_id: "{{ job_info['job']['id'] }}"
        topic_id: "{{ job_info['job']['topic_id'] }}"
        topic_name: "{{ job_info['job']['topic']['name'] }}"
        remoteci_id: "{{ job_info['job']['remoteci_id'] }}"
        components: "{{ job_info['job']['components'] }}"
        product: "{{ job_info['job']['topic']['product_id'] }}"

    - name: 'Update job name with topic_name'
      dci_job:
        id: "{{ job_id }}"
        name: '{{ topic_name }}'

    - name: 'Set DCI tags for the current job'
      dci_job:
        id: "{{ job_id }}"
        tags: '{{ dci_tags }}'
      when: dci_tags | length > 0

    - name: 'Upload settings yml file'
      ignore_errors: yes
      dci_file:
        path: /etc/dci-rhel-agent/settings.yml
        name: settings.yml
        job_id: "{{ hostvars.localhost.job_id }}"

    - name: 'Upload hooks directory contents'
      dci_file:
        path: "{{ item }}"
        name: "{{ item | basename }}"
        job_id: "{{ hostvars.localhost.job_id }}"
      with_fileglob:
        - /etc/dci-rhel-agent/hooks/*

    - name: 'Check partner user-tests hook file is present'
      stat:
        path: '/etc/dci-rhel-agent/hooks/user-tests.yml'
      register: check_user_tests_hook_file

- name: 'Prepare'
  hosts: localhost
  gather_facts: no
  tags:
    - pre-run
    - jumpbox
  tasks:
    - block:
        - name: 'Add job state pre-run'
          dci_job:
            id: "{{ job_id }}"
            status: "pre-run"

        - name: 'Create temp dir'
          include_tasks: create_temp_dir.yml

        - name: 'Check pre-run hook file is present'
          stat:
            path: '/etc/dci-rhel-agent/hooks/pre-run.yml'
          register: check_pre_run

        - name: 'Process Suts'
          include_tasks: process_suts.yml
          loop: "{{ systems | dict2items }}"
          loop_control:
            loop_var: system

        - name: 'Run the pre-run hook if present'
          include_tasks: '/etc/dci-rhel-agent/hooks/pre-run.yml'
          when: check_pre_run.stat.exists
      rescue:
        - name: Teardown error
          include_tasks: teardown_error.yml

- name: 'Prepare the Distro and Harness'
  hosts: localhost
  gather_facts: yes
  tags:
    - pre-run
  tasks:
    - block:
        - name: 'Download RHEL'
          include_tasks:
            file: download.yml
            apply:
              tags: download
          tags: always

        - name: 'Process Compose'
          include_tasks: process_compose.yml

        - name: 'Download harness'
          include_tasks: dci-harness.yml

      rescue:
        - name: Teardown error
          include_tasks: teardown_error.yml

- name: 'Prep install'
  hosts: localhost
  tags:
    - install
  tasks:
    - block:
        - name: 'Add job state running'
          dci_job:
            id: "{{ hostvars.localhost.job_id }}"
            status: "running"

        - name: 'Gather system arches'
          include_tasks: gather_arches.yml
          loop: "{{ systems | dict2items }}"
          loop_control:
            loop_var: system

        - name: 'Tag job with SUT(s) arches'
          dci_job:
            id: "{{ job_id }}"
            tags: '{{ arch_tags | unique }}'

      rescue:
        - name: Teardown failure
          include_tasks: teardown_failure.yml

- name: 'Install Systems Under Test'
  hosts: sut
  gather_facts: False
  strategy: free
  tags:
    - install
  tasks:
    - block:
        - name: 'Wait for SUT(s) to Install'
          include_tasks: install_suts.yml
      rescue:
        - name: Teardown failure
          include_tasks: teardown_failure.yml

- name: 'Launch tests'
  hosts: localhost
  gather_facts: yes
  tags:
    - tests
    - jumpbox
  tasks:
    - block:
        - name: 'Check partner tests hook file is present'
          stat:
            path: '/etc/dci-rhel-agent/hooks/tests.yml'
          register: check_tests_hook_file

        - name: 'Launch partner tests if present'
          include_tasks: '/etc/dci-rhel-agent/hooks/tests.yml'
          when: check_tests_hook_file.stat.exists
      rescue:
        - name: Teardown failure
          include_tasks: teardown_failure.yml

- name: 'Launch tests on SUTs'
  hosts: sut
  gather_facts: no
  tags:
    - tests
    - sut
  tasks:
    - block:
        - name: 'Launch partner tests if present'
          include_tasks: '/etc/dci-rhel-agent/hooks/user-tests.yml'
          when: hostvars.localhost['check_user_tests_hook_file'].stat.exists
      rescue:
        - name: Teardown failure
          include_tasks: teardown_failure.yml

- name: 'Grab logs'
  hosts: localhost
  gather_facts: no
  tags:
    - post-run
  tasks:
    - block:
        - name: 'Add job state post-run'
          dci_job:
            id: "{{ hostvars.localhost.job_id }}"
            status: "post-run"

        - name: 'Upload logs to DCI Control server'
          include_tasks: logs.yml

      rescue:
        - name: Teardown failure
          include_tasks: teardown_failure.yml

- name: 'Success'
  hosts: localhost
  gather_facts: no
  tags:
    - success
    - jumpbox
  tasks:
    - name: 'Run the success'
      include_tasks: teardown_success.yml
