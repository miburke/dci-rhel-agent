---
#
# Tasks are included to run on localhost,
# Delegate_to: localhost when needed.
#
- name: Collect and Upload logs
  block:
    - name: Check if ansible log exists
      stat:
        path: /var/log/ansible.log
      delegate_to: localhost
      register: ansible_log_check

    #When Ansible verbosity is at levels 3 or 4, ansible copy module has checksum error due
    #to file changing between generation of initial checksum and final checksum after copy
    - name: Copy ansible.log file to logs directory
      shell: 'cp /var/log/ansible.log {{ job_logs.path }}'
      delegate_to: localhost
      when: ansible_log_check.stat.exists

    - name: Upload logs directory to DCI Control Server
      delegate_to: localhost
      environment:
        - DCI_CLIENT_ID: "{{ hostvars.localhost.dci_client_id }}"
        - DCI_API_SECRET: "{{ hostvars.localhost.dci_api_secret }}"
        - DCI_CS_URL: "{{ hostvars.localhost.dci_cs_url }}"
      dci_file:
        path: '{{ item }}'
        name: '{{ item | basename }}'
        job_id: '{{ hostvars.localhost.job_id }}'
      with_fileglob:
        - '{{ hostvars.localhost.job_logs.path }}/*'
        - '/logs/provisioner/*'
        - '/logs/lab/*'

    - name: Delete tmp logs directory
      file:
        state: absent
        path: "{{ item }}"
      with_items:
        - "{{ job_logs.path }}"
